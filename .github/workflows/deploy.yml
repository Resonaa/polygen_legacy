name: Deploy

on: [push]

env:
  CARGO_TERM_COLOR: always

jobs:
  deploy:

    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3
    
    - name: Upload      
      uses: garygrossgarten/github-action-scp@release
      with:
        local: ./
        remote: ~/polygen
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USER }}
        password: ${{ secrets.PASS }}
        dotfiles: true
        privateKey: ${{ secrets.SERVER_SSH_KEY }}

    - name: Deploy
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USER }}
        password: ${{ secrets.PASS }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          cd ~/polygen
          ~/.cargo/bin/cargo build --release
          screen -S polygen -X quit
          screen -S polygen
          sudo target/release/polygen